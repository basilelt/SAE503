---
- name: Initialize Kubernetes Master
  command: kubeadm init --token {{ kubeadm_token }} --token-ttl 0 --kubernetes-version stable-1 --pod-network-cidr=10.244.0.0/16 --apiserver-advertise-address={{ ip }}
  args:
    creates: /etc/kubernetes/admin.conf
  when: inventory_hostname in groups['masters']

- name: Setup kubeconfig for vagrant user
  command: "{{ item }}"
  loop:
    - mkdir -p /home/vagrant/.kube
    - cp -i /etc/kubernetes/admin.conf /home/vagrant/.kube/config
    - chown vagrant:vagrant /home/vagrant/.kube/config
  when: inventory_hostname in groups['masters']

- name: Install Flannel CNI
  command: kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
  become: true
  environment:
    KUBECONFIG: /etc/kubernetes/admin.conf
  when: inventory_hostname in groups['masters']