---
- name: Check swap status
  ansible.builtin.command: swapon --show
  register: swap_status
  changed_when: false

- name: Disable swap
  ansible.builtin.command: swapoff -a
  when: swap_status.stdout != ""
  changed_when: swap_status.stdout != ""

- name: Remove swap entry from /etc/fstab
  ansible.builtin.lineinfile:
    path: /etc/fstab
    regexp: '^([^#].*?\sswap\s+sw\s+.*)$'
    line: '# \1'
    backrefs: true

- name: Enable kernel modules
  modprobe:
    name: "{{ item }}"
    state: present
  loop:
    - overlay
    - br_netfilter

- name: Add kernel modules to /etc/modules-load.d/
  ansible.builtin.copy:
    content: |
      overlay
      br_netfilter
    dest: /etc/modules-load.d/k8s.conf
    mode: '0644'

- name: Set sysctl params
  ansible.builtin.sysctl:
    name: "{{ item.name }}"
    value: "{{ item.value }}"
    state: present
    reload: true
  loop:
    - { name: "net.bridge.bridge-nf-call-iptables", value: "1" }
    - { name: "net.bridge.bridge-nf-call-ip6tables", value: "1" }
    - { name: "net.ipv4.ip_forward", value: "1" }

- name: Ensure kubelet service directory exists
  ansible.builtin.file:
    path: /etc/systemd/system/kubelet.service.d
    state: directory
    mode: '0755'

- name: Create 10-kubeadm.conf using a template
  ansible.builtin.template:
    src: 10-kubeadm.conf.j2
    dest: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    mode: '0644'

- name: Deploy kubeadm-flags.env
  ansible.builtin.template:
    src: templates/kubeadm-flags.env.j2
    dest: /var/lib/kubelet/kubeadm-flags.env
    owner: root
    group: root
    mode: '0644'

- name: Create kubelet config file
  ansible.builtin.template:
    src: kubelet-config.yaml.j2
    dest: /var/lib/kubelet/config.yaml
    mode: '0644'

- name: Update kubelet service file
  ansible.builtin.lineinfile:
    path: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    line: 'Environment="KUBELET_CONFIG_ARGS=--config=/var/lib/kubelet/config.yaml"'
    insertafter: '^Environment="KUBELET_KUBECONFIG_ARGS'
    create: true
    mode: '0644'
  notify: Restart kubelet
